define(["butterfly/view","butterfly","shared/js/location/Location","../account/account-client","dialog","../shared/js/loading","shared/js/autosize.min","json!../shared/js/location/data/data.min.json"],function(a,b,c,d,e,f,g,h){return a.extend({events:{"click .go-back":"goBack","click #pro-city":"selectProCity","click #select-areas":"selectAreas","click #saveAddress":"submitAddress","touchmove .header,.container":"blurInput"},render:function(b){a.prototype.render.call(this),this.loading=new f({parentEl:this.$(".container")[0]})},getAddressString:function(a,b,c){var d=this,e=_.find(h.data,function(b){return b.areaid==a}),f=_.find(e.al,function(a){return a.areaid==b}),g=_.find(f.al,function(a){return a.areaid==c}),i={provinceName:e.areaname,cityName:f.areaname,areaName:g.areaname};return d.defaultArr=[e,f],i},goBack:function(){butterfly.back(null,{isEdit:!1})},editAddress:function(){var a=this,b=a.valueCheck();b&&(b.id=a.id,d.editShippingAddress({data:b,beforeSend:function(){a.loading&&a.loading.show()},success:function(a){0==a.result?(butterfly.back(null,{isEdit:!0}),e.showToast("修改收货地址成功！")):e.showToast(MyClient.statusString(a.result))},error:function(a){e.showToast("数据加载失败，请检查网络")},complete:function(){a.loading&&a.loading.hide()}}))},initEidtAddressView:function(a){var b=this,c=b.initData,d=b.getAddressString(c.provinceId,c.cityId,c.areaId);b.getProData(),b.getCityData(b.defaultArr[0]),b.getAreasData(b.defaultArr[1]),b.$(".header h1").text("修改收货地址"),b.$("#receiver").val(c.receiver),b.$("#mobile").val(c.mobile),b.$("#zip").val(c.zip),b.$("#addressCont").text(c.address),b.id=c.id,d.provinceName||d.cityName?(b.$("#pro-city .select-text").val(d.provinceName+d.cityName),b.hideHint(b.$el.find("#pro-city .select-text")),b.$el.find("#pro-city .select-text").attr("data-value",c.provinceId+","+c.cityId)):b.$("#pro-city .select-text").val("请选择"),d.areaName?(b.$("#select-areas .select-text").val(d.areaName),b.hideHint(b.$el.find("#select-areas .select-text")),b.$el.find("#select-areas .select-text").attr("data-value",c.areaId)):b.$("#select-areas .select-text").val("请选择")},onShow:function(a){a&&a.type&&"editAddress"===a.type?(this.type=a.type,this.initData=JSON.parse(a.data),this.initEidtAddressView(a)):this.getProData(),a&&a.backWhere&&(this.backWhere=a.backWhere),g(document.querySelectorAll("textarea"))},selectProCity:function(){var a=this;setTimeout(function(){a.$("#selectProvinces").mobiscroll("show")},300)},selectAreas:function(){var a=this;a.$("#pro-city .select-text").attr("data-value")?setTimeout(function(){a.$("#selectAreas").mobiscroll("show")},300):e.showToast("请选择省市")},getProData:function(){var a=this,b="",c=_.template(a.$el.find("#provinces-template").html());_.each(h.data,function(a){b+=c(a)}),a.$el.find(".select-provinces").html(b),setTimeout(function(){a.initMobiscroll()},100)},showHint:function(a){a.val("请选择"),a.addClass("hint"),a.removeAttr("data-value")},hideHint:function(a){a.removeClass("hint")},getCityData:function(a){var b=this,c=a.al,d=_.template(b.$el.find("#city-template").html()),e="";_.each(c,function(a){e+=d(a)}),b.$el.find(".select-citys").html(e),setTimeout(function(){b.initMobiscrollCity(a)},100)},getAreasData:function(a){var b=this,c=a.areaid;if(!b.preCityId||b.preCityId!==c){b.showHint(b.$el.find("#select-areas .select-text")),b.preCityId=c;var d=a.al,e=_.template(b.$el.find("#areas-template").html()),f="";_.each(d,function(a){f+=e(a)}),b.$el.find(".select-areas").html(f),console.log(f),setTimeout(function(){b.initMobiscrollAreas(d)},100)}},getDefaultIndex:function(a,b){var c=this;a.onBeforeShow=function(a){a.setValue(c.initData[b]),a.refresh()}},initMobiscroll:function(){var a=this,b={theme:"ios",mode:"Scroller",display:"bottom",lang:"zh",context:a.$el,inputClass:"province-input",onShow:function(a){},onSelect:function(b,c){var d=c.getValue();a.initData&&(a.initData.provinceId=d);var e=_.find(h.data,function(a){return a.areaid==d});a.getCityData(e)}};"editAddress"===a.type&&a.getDefaultIndex(b,"provinceId"),a.$el.find("#selectProvinces").mobiscroll().select(b)},initMobiscrollCity:function(a){var b=this,c={theme:"ios",mode:"Scroller",display:"bottom",lang:"zh",context:b.$el,inputClass:"citys-input",onShow:function(a){},onSelect:function(c,d){var e=d.getValue();b.initData&&(b.initData.cityId=e);var f=_.find(a.al,function(a){return a.areaid==e});b.$el.find("#pro-city .select-text").val(a.areaname+c),b.$el.find("#pro-city .select-text").attr("data-value",a.areaid+","+e),b.hideHint(b.$el.find("#pro-city .select-text")),b.getAreasData(f)}};"editAddress"===b.type&&b.getDefaultIndex(c,"cityId"),b.$el.find("#selectCity").mobiscroll().select(c),("editAddress"!==b.type||b.showCityNoFirst)&&setTimeout(function(){b.$("#selectCity").mobiscroll("show")},100),"editAddress"===b.type&&(b.showCityNoFirst=!0)},initMobiscrollAreas:function(a){var b=this,c={theme:"ios",mode:"Scroller",display:"bottom",lang:"zh",context:b.$el,inputClass:"areas-input",onShow:function(a){},onSelect:function(a,c){var d=c.getValue();b.$el.find("#select-areas .select-text").val(a),b.$el.find("#select-areas .select-text").attr("data-value",d),b.hideHint(b.$el.find("#select-areas .select-text")),b.initData&&(b.initData.areaId=d)}};"editAddress"===b.type&&b.getDefaultIndex(c,"areaId"),b.$el.find("#selectAreas").mobiscroll().select(c)},filterInvalidCity:function(a){return"33"==a||"34"==a||"35"==a?!0:!1},submitAddress:function(){var a=this;"editAddress"===a.type?a.editAddress():a.saveAddress()},saveAddress:function(){var a=this,b=a.valueCheck();b&&MyClient.createShippingAddress({data:b,beforeSend:function(){a.loading&&a.loading.show()},success:function(b){if(0==b.result)if(a.backWhere){var c=a.getAddressString(b.data.provinceId,b.data.cityId,b.data.areaId);b.data.provinceName=c.provinceName,b.data.cityName=c.cityName,b.data.areaName=c.areaName,butterfly.back(parseInt(a.backWhere),{address:b.data})}else butterfly.back(null,{isEdit:!0});else e.showToast(MyClient.statusString(b.result))},error:function(a){e.showToast("数据加载失败，请检查网络")},complete:function(){a.loading&&a.loading.hide()}})},valueCheck:function(){var a=this,b=a.$("#receiver").val().trim(),c=a.$("#mobile").val().trim(),d=a.$("#zip").val().trim(),f=a.$("#select-areas .select-text").attr("data-value"),g=a.$("#pro-city .select-text").attr("data-value"),h=a.$("#addressCont").val().trim();if(!b||b.length<1||b.length>7)return void e.showToast("收件人名字长度为1到7位");var i=/^1\d{10}$/;if(!i.test(c))return void e.showToast("手机号码格式不正确");if(!d||6!==d.length)return void e.showToast("邮编长度必须为6位");if(!g)return void e.showToast("请选择省市");if(!f)return void e.showToast("请选择区县");if(!h||h.length<1)return void e.showToast("收货地址不能为空");if(h.length>100)return void e.showToast("收货地址不能超过100字");var j=g.split(",");if(2!==j.length)return void e.showToast("请选择省市");var k=j[0],l=j[1];if(a.filterInvalidCity(k))return void e.showToast("该区域暂不支持");var m={receiver:b.filterHtml(),mobile:c,zip:d,address:h.filterHtml(),provinceId:k,cityId:l,areaId:f};return m},blurInput:function(){this.$(":focus").blur()}})});