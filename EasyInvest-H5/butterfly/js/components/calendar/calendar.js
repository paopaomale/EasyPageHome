define(["text!./calendar.html","swipe","moment","zepto","iscroll","./lunarCal","./fx"],function(a,b,c,d,e,f,g){return Piece.View.extend({initDate:new Date,initViewType:"week",events:{"click .cal-info":"onActiveDay","click .goBackToToday":"onGoBackToToday","click .cal-next-page":"onGoNext","click .cal-prev-page":"onGoPrev","click .toggleView":"onToggleView","touchstart #calendar-content":"onTouchBegin","touchmove #calendar-content":"onTouchMoved","touchend #calendar-content":"onTouchEnd"},uiGetActiveDate:function(){return moment(this.activeDate)},uiSetActiveDate:function(a,b){if(!a)return!1;var c=this,e=c.activeDate,f=c.uiGetCurrentViewType(),g=moment(a).format("YYYY-MM-DD");if(c.activeDate&&c.activeDate.format("YYYY-MM-DD")==g)return!0;var h="week"==f?this.weekWrapper:this.monthWrapper,i="#"+("week"==f?"w":"m")+g,j=d(h.children()[1]).find(i);return j&&0!=j.length?(h.find(".activeDay").removeClass("activeDay"),j.closest(".cal-info").addClass("activeDay"),c.activeDate=moment(a),c.uiUpdateCalendarTitle(a),b&&c.trigger("dateChanged",c,e,moment(a)),!0):!1},uiGetCurrentViewType:function(){var a=this;return a.weekSwiper&&"none"!=a.weekWrapper.css("display")?"week":a.monthSwiper&&"none"!=a.monthWrapper.css("display")?"month":void 0},uiSetCurrentViewType:function(a){var b=this,c=b.uiGetCurrentViewType();c!=a&&(b.onTouchBegin({touches:[]}),b.prepareDragging(null,0),b.finishDragging(),delete b.dragContext)},uiGetCurrentDateElements:function(){},uiSetTodayButtonStyle:function(){var a=moment(new Date),b=this.activeDate;a.format("YYYY-MM-DD")==b.format("YYYY-MM-DD")?this.$el.find(".goBackToToday").css("display","none"):this.$el.find(".goBackToToday").css("display","inline")},uiGoBackToToday:function(){var a=this,b=this.uiGetCurrentViewType(),c=new Date;"week"==b?a.uiInitWeekview(c):a.uiInitMonthview(c),a.uiSetActiveDate(c,!0),a.uiSetTodayButtonStyle(),a.trigger("goBackToTodaySucceed",a)},onGoBackToToday:function(a){this.uiGoBackToToday()},uiInitialize:function(){var a=this,b=a.initDate?a.initDate:new Date;a.calendar=d(a.el),a.monthWrapper=this.$el.find("#slider-monthview>.swipe-wrap"),a.weekWrapper=this.$el.find("#slider-weekview>.swipe-wrap"),a.monthSlider=this.$el.find("#slider-monthview"),a.activeDate=null,"week"==a.initViewType?a.uiInitWeekview(b):a.uiInitMonthview(),a.uiSetActiveDate(b),a.uiSetTodayButtonStyle()},render:function(){return d(this.el).html(a),Piece.View.prototype.render.call(this),this.uiInitialize(),this.listenToDragging(),this},remove:function(){Piece.View.prototype.remove.call(this,arguments)},listenToDragging:function(){var a=this;this.bind("prepareDragging",function(b,c){a.isDraggingAuto=!0,a.$el.find(".dateMask").show()}),this.bind("finishDragging",function(b,c){a.isDraggingAuto=!1,a.$el.find(".dateMask").hide()}),this.bind("cancelDragging",function(b,c){a.isDraggingAuto=!1,a.$el.find(".dateMask").hide()})},calcWeekIndexInMonthview:function(a){var b=this.getMondayBefore(a.format("YYYY-MM-01")),c=parseInt((a._d.getTime()-b._d.getTime())/864e5);return(c-c%7)/7},isInSameWeek:function(a,b){return this.getMondayBefore(a).format("YYYY-MM-DD")==this.getMondayBefore(b).format("YYYY-MM-DD")},isInSameMonth:function(a,b){return a.format("YYYY-MM")==b.format("YYYY-MM")},destroyWeekview:function(){var a=this,b=a.weekWrapper;b.html(""),a.weekSwiper&&(a.weekSwiper.kill(),delete a.weekSwiper)},destroyMonthview:function(){var a=this,b=a.monthWrapper;b.html(""),a.monthSwiper&&(a.monthSwiper.kill(),delete a.monthSwiper)},getMondayBefore:function(a){var a=moment(a),b=a.days();return a.subtract("days",0==b?6:b-1)},loadWeekTemplate:function(a,b){var c=_.template(d("#week-template").html());return c({dateOfMonday:a,dateIdPrefix:b,LunarCal:f})},createMonthviewPage:function(a){for(var b=this,c=d("<div class='cal-month'></div>"),e=0;6>e;e++)c.append(b.loadWeekTemplate(moment(a).add("days",7*e),"m"));var f=c.find(".cal-day:nth-child(2)").find(".cal-content").attr("id").substring(1),g=moment(f).months(),h=c.find(".cal-content");return _.each(h,function(a){var b=d(a).attr("id").substring(1);g!=moment(b).months()&&(c.find("#m"+b).addClass("cal-other-month"),c.find("#m"+b).parent().find(".meeting-point").remove())}),c.find("#m"+moment(new Date).format("YYYY-MM-DD")).css("color","#B94326"),c},uiInitWeekview:function(a){var b=this,c=b.weekWrapper,d=b.getMondayBefore(a);b.destroyWeekview(),c.html(""),c.append(b.loadWeekTemplate(moment(d).subtract("days",7),"w")),c.append(b.loadWeekTemplate(moment(d),"w")),c.append(b.loadWeekTemplate(moment(d).add("days",7),"w")),b.uiSetTodayStyle(),b.weekSwiper=new Swipe(b.$el.find("#slider-weekview")[0],{startSlide:1,speed:400,auto:!1,continuous:!1,disableScroll:!1,stopPropagation:!1,transitionEnd:function(){var a=b.weekSwiper.getPos();1!=a&&(b.uiWeekviewDidSwipeTo(a),b.trigger("viewDidSwiped",b)),console.log("weekview transitionEnd:"+a)}})},uiInitMonthview:function(a,b,c){var d=this,e=d.monthWrapper,f=moment(a).subtract("month",1).format("YYYY-MM-01"),g=moment(a).format("YYYY-MM-01"),h=moment(a).add("month",1).format("YYYY-MM-01");d.destroyMonthview(),d.uiSetNormalWeek(),isNaN(b)||e.css("top",b+"px"),isNaN(c)||e.css("height",c+"px"),e.html(""),e.append(d.createMonthviewPage(d.getMondayBefore(f))),e.append(d.createMonthviewPage(d.getMondayBefore(g))),e.append(d.createMonthviewPage(d.getMondayBefore(h))),d.monthSwiper=new Swipe(d.monthSlider[0],{startSlide:1,speed:400,auto:!1,continuous:!1,disableScroll:!1,stopPropagation:!1,transitionEnd:function(){var a=d.monthSwiper.getPos();1!=a&&(d.uiMonthviewDidSwipeTo(a),d.trigger("viewDidSwiped",d)),console.log("monthview transitionEnd:"+a)}})},uiWeekviewDidSwipeTo:function(a){if(0==a||2==a){var b=this,c=b.weekWrapper,d=b.uiGetFirstDateInPage(c,a),e=b.uiGetActiveDate();b.uiInitWeekview(d),b.uiSetTodayStyle(),e&&(e=2==a?e.add("days",7):e.subtract("days",7),b.uiSetActiveDate(e,!0)),b.uiSetTodayButtonStyle()}},uiMonthviewDidSwipeTo:function(a){if(0==a||2==a){var b=this,c=b.monthWrapper,d=b.uiGetFirstDateInPage(c,a),e=b.uiGetActiveDate(),f=d.add("days",15);b.uiInitMonthview(f),e&&(e.format("YYYY-MM")!=f.format("YYYY-MM")&&(e=2==a?e.add("month",1):e.subtract("month",1)),b.uiSetActiveDate(e,!0)),b.uiSetTodayButtonStyle()}},uiGetFirstDateInPage:function(a,b){var c=d(a.children()[b]).find(".content-day1").first().attr("id");return moment(c.substring(1))},uiUpdateCalendarTitle:function(a){this.$el.find("#calendar-header>.header-year").html(moment(a).format("YYYY")+"年"),this.$el.find("#calendar-header>.header-month").html(moment(a).format("M")+"月")},uiSetTodayStyle:function(){var a=this,b=a.uiGetCurrentViewType();if("month"!=b){var c=moment(new Date);a.$el.find("#w"+c.format("YYYY-MM-DD")).css("color","#B94326");var d=c.days();d=0==d?7:d;var e=a.$el.find("#slider-weekview"),f=e.find(".cal-day:nth-child(2)").find(".content-day"+d).attr("id").substring(1);if(f==c.format("YYYY-MM-DD")){var g=".header-day"+d;a.$el.find(g).text("今天")}else a.uiSetNormalWeek(),e.find(".cal-content").css("color","")}},uiSetNormalWeek:function(){for(var a=this,b=["一","二","三","四","五","六","日"],c=1;7>=c;c++)itemId=".header-day"+c,a.$el.find(itemId).text("星期"+b[c-1])},onGoNext:function(){var a=this.uiGetCurrentViewType();"month"==a?this.monthSwiper.next():this.weekSwiper.next()},onGoPrev:function(){var a=this.uiGetCurrentViewType();"month"==a?this.monthSwiper.prev():this.weekSwiper.prev()},onActiveDay:function(a){var b=this,c=d(a.currentTarget).find(".cal-content");if(0!=c.length){var e=b.activeDate,f=c.attr("id").substring(1);if("month"==b.uiGetCurrentViewType()){var g=e.format("YYYY-MM-01"),h=moment(g).add("month",1).format("YYYY-MM-DD");g>f?(b.activeDate=moment(f).add("month",1),b.monthSwiper.prev(),b.trigger("dateChanged",b,e,moment(f))):f>=h?(b.activeDate=moment(f).subtract("month",1),b.monthSwiper.next(),b.trigger("dateChanged",b,e,moment(f))):b.uiSetActiveDate(f,!0)}else b.uiSetActiveDate(f,!0);b.uiSetTodayButtonStyle()}},onToggleView:function(){var a=this;if(!this.isDraggingAuto){var b=this.uiGetCurrentViewType(),c="week"==b?"month":"week";if("week"==b){var c="month";a.$el.find(".toggleView").text("周视图")}else{var c="week";a.$el.find(".toggleView").text("月视图")}this.uiSetCurrentViewType(c)}},onTouchBegin:function(a){this.dragContext||(this.dragContext={isDragging:!1,lastTouch:null,calendarHeight:0,weekviewHeight:55,monthviewTop:0,weekRowIndex:0,swipeAccumulateY:0,swipeAccumulateX:0,isHorizScrolling:!1,viewTypeBeforeDrag:null}),this.dragContext.lastTouch=d.extend({},a.touches[0]),this.trigger("touchEvent","touchBegin",this)},onTouchMoved:function(a){var b=this,c=a.touches[0],e=6,f=b.dragContext,g=c.screenY-f.lastTouch.screenY,h=f.isDragging;if(f.swipeAccumulateY+=g,f.swipeAccumulateX+=c.screenX-f.lastTouch.screenX,f.lastTouch=d.extend({},c),!f.isDragging&&!f.isHorizScrolling&&Math.abs(f.swipeAccumulateX)>e&&(f.isHorizScrolling=!0),!f.isHorizScrolling){if(!f.isDragging){var i=b.uiGetCurrentViewType(),j="week"==i?f.swipeAccumulateY:-f.swipeAccumulateY;j>e&&(f.isDragging=!0)}f.isDragging&&(h||b.prepareDragging(a,g),b.processDragging(a,g),a.preventDefault(),a.stopPropagation())}},onTouchEnd:function(a){var b=this,c=b.dragContext,d=c.weekviewHeight;if(c.isDragging){var e="week"==c.viewTypeBeforeDrag?c.swipeAccumulateY:-c.swipeAccumulateY;e>d?b.finishDragging(a):b.cancelDragging(a)}delete b.dragContext,this.trigger("touchEvent","touchEnd",this)},animiateAllOnce:function(a,b,c){var d=a.length;void 0==b&&(b=400),_.each(a,function(a){a.elem.animate(a.csses,{duration:b,easing:"linear",complete:function(){0==--d&&c&&c()}})})},finishDragging:function(a){var b=this,c=b.dragContext,d=c.viewTypeBeforeDrag;if("week"==d){var e=6*c.weekviewHeight,f=c.calendarHeight-c.weekviewHeight;b.destroyWeekview(),b.$el.find(".toggleView").text("周视图"),b.weekWrapper.css("display","inherit"),b.animiateAllOnce([{elem:b.monthWrapper,csses:{top:"0px",height:e+"px"}},{elem:b.calendar,csses:{height:f+e+"px"}},{elem:b.monthSlider,csses:{height:"330px"}}],400,function(){b.trigger("viewChanged",b,d),b.trigger("finishDragging",b)})}else{var e=Math.abs(c.monthviewTop)+c.weekviewHeight,f=c.calendarHeight-6*c.weekviewHeight,g=b.activeDate;b.$el.find(".toggleView").text("月视图"),b.animiateAllOnce([{elem:b.monthWrapper,csses:{top:c.monthviewTop+"px",height:e+"px"}},{elem:b.calendar,csses:{height:f+c.weekviewHeight+"px"}},{elem:b.monthSlider,csses:{height:"55px"}}],400,function(){b.destroyMonthview(),b.uiInitWeekview(g),b.activeDate=null,b.uiSetActiveDate(g),b.trigger("viewChanged",b,d),b.trigger("finishDragging",b)})}},cancelDragging:function(a){var b=this,c=b.dragContext,d=c.viewTypeBeforeDrag;"week"==d?b.animiateAllOnce([{elem:b.monthWrapper,csses:{top:c.monthviewTop+"px",height:Math.abs(c.monthviewTop)+c.weekviewHeight+"px"}},{elem:b.calendar,csses:{height:c.calendarHeight+"px"}},{elem:b.monthSlider,csses:{height:"55px"}}],200,function(){b.destroyMonthview(),b.uiSetTodayStyle(),b.weekWrapper.css("display","inherit"),b.trigger("cancelDragging",b,d)}):b.animiateAllOnce([{elem:b.monthWrapper,csses:{top:"0px",height:6*c.weekviewHeight+"px"}},{elem:b.calendar,csses:{height:c.calendarHeight+"px"}},{elem:b.monthSlider,csses:{height:"330px"}}],200,function(){b.trigger("cancelDragging",b,d)})},prepareDragging:function(a,b){var c=this,d=c.dragContext,e=c.uiGetCurrentViewType(),f=c.activeDate,g=c.calcWeekIndexInMonthview(f),h="week"==e?c.weekWrapper.height():c.monthWrapper.height()/6;d.weekRowIndex=g,d.calendarHeight=c.calendar.height(),d.weekviewHeight=h,d.monthviewTop=-h*g,d.viewTypeBeforeDrag=e,"week"==e&&(c.weekWrapper.css("display","none"),c.uiInitMonthview(f,d.monthviewTop,Math.abs(d.monthviewTop)+h),c.calendar.css("height",d.calendarHeight+"px"),c.activeDate=null,c.uiSetActiveDate(f)),c.trigger("prepareDragging",c)},processDragging:function(a,b){var c=this,d=parseInt(c.monthWrapper.css("top")),e=c.monthWrapper.height(),f=6*c.dragContext.weekviewHeight,g=Math.abs(c.dragContext.monthviewTop)+c.dragContext.weekviewHeight,h=e+d;if(55>h?h=55:h>330&&(h=330),c.monthSlider.height(h),b>0){if(0>d){var i=d+b>0?-d:b;c.monthWrapper.css("top",d+i+"px"),c.calendar.css("height",c.calendar.height()+i+"px")}else if(f>e){var i=e+b>f?f-e:b;c.monthWrapper.css("height",e+i+"px"),c.calendar.css("height",c.calendar.height()+i+"px")}}else if(0>b){var j=c.dragContext.monthviewTop;if(b=-b,e>g){var i=g>e-b?e-g:b;c.monthWrapper.css("height",e-i+"px"),c.calendar.css("height",c.calendar.height()-i+"px")}else if(d>j){var i=j>d-b?d-j:b;c.monthWrapper.css("top",d-i+"px"),c.calendar.css("height",c.calendar.height()-i+"px")}}c.trigger("processDragging",c)}})});