define(["underscore","zepto"],function(a,b){var c=function(){this.downloadQueue=[],this.completeQueue=[],this.reloadQueue=[],this.loadState(),this.listenToEvent(),this.successCount=0,this.errorCount=0};return a.extend(c.prototype,Backbone.Events,{listenToEvent:function(){this.listenTo(this,"removeSuccessCount",this.onRemoveSuccessCount),this.listenTo(this,"removeErrorCount",this.onRemoveErrorCount),this.listenTo(this,"getErrorCount",this.onGetErrorCount)},loadState:function(){var b=this,c=null;try{var d=window.localStorage.username;window.localStorage[d+"_ichangan.download-manager"]&&(c=JSON.parse(window.localStorage[d+"_ichangan.download-manager"]))}finally{}return c&&"null"!=c?(this.completeQueue=c.completeQueue,this.reloadQueue=c.reloadQueue,void(window.cordova&&(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,a.each(c.downloadQueue,function(a){b.removeFile(a)})))):(this.completeQueue=[],void(this.reloadQueue=[]))},saveState:function(){var a=window.localStorage.username,b={downloadQueue:this.downloadQueue,completeQueue:this.completeQueue,reloadQueue:this.reloadQueue};window.localStorage[a+"_ichangan.download-manager"]=JSON.stringify(b)},onDownload:function(a,b,c,d,e,f,g){var h=this,i=b,j=a;if(!h.findDownloadTask(a)){h.findReloadTask(a)&&(h.removeTask(a),h.saveState());var k={url:j,downloadUrl:i,filename:c,target:d},l=encodeURI(i);k.ft=new FileTransfer,k.ft.onprogress=function(a){a.lengthComputable&&(e&&e(j,a.loaded/a.total),h.findDownloadTask(j).downloadProgress=a.loaded/a.total,h.trigger("downloadProgress",h.findDownloadTask(j)))},h.downloadQueue.push(k),h.saveState(),k.ft.download(l,encodeURI(d),function(a){delete k.ft,h.completeQueue.push(k),h.removeTask(k.url),h.saveState(),f&&f(k.url,k.filename,a),h.trigger("downloadSuccess",k)},function(a){h.removeTask(k.url),h.notAddToReloadQueue||h.findReloadTask(k.url)||h.reloadQueue.push(k),h.saveState(),g&&g(k.url,k.filename),h.trigger("downloadError",k,h.notAddToReloadQueue),h.notAddToReloadQueue=!1},!1,{headers:{}})}},abort:function(a){this.notAddToReloadQueue=!0;var b=this.findDownloadTask(a);b&&b.ft&&b.ft.abort()},findCompleteTask:function(b){return a.find(this.completeQueue,function(a){return a.url==b})},findDownloadTask:function(b){return a.find(this.downloadQueue,function(a){return a.url==b})},findReloadTask:function(b){return a.find(this.reloadQueue,function(a){return a.url==b})},removeTask:function(a){var b=this,c=b.downloadQueue.indexOf(b.findDownloadTask(a)),d=b.completeQueue.indexOf(b.findCompleteTask(a)),e=b.reloadQueue.indexOf(b.findReloadTask(a));c>-1?b.downloadQueue.splice(c,1):d>-1?b.completeQueue.splice(d,1):e>-1&&b.reloadQueue.splice(e,1)},deleteFile:function(a,b){var c=this;c.findDownloadTask(a)?c.removeDownloadingTask(a,b):c.findCompleteTask(a)?c.removeFile(c.findCompleteTask(a),b):c.findReloadTask(a)?(c.removeTask(a),c.saveState(),c.successCount=c.successCount+1,c.triggerReload(b)):(c.successCount=c.successCount+1,c.triggerReload(b))},removeDownloadingTask:function(a,b){var c=this;c.abort(a),setTimeout(function(){c.removeTask(a),c.saveState(),c.trigger("removeSuccessCount",b)},0)},getTargetCount:function(b){var c=0;for(var d in window.localStorage)if(d.indexOf("_ichangan.download-manager")>-1){var e=window.localStorage.getItem(d);if(e&&""!==e&&"null"!==e){var f=JSON.parse(e);f.completeQueue&&f.completeQueue.length>0&&(console.log("用户:"+d),a.each(f.completeQueue,function(a){a.target&&a.target.indexOf(b)>-1&&(c+=1,console.log("target的数目:"+c))}))}}return c},removeFile:function(a,b){var c=this;window.cordova&&window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(d){if("iOS"==device.platform)var e=a.target.substring(d.root.nativeURL.length);else var f=a.target.indexOf(butterfly.config.identifier+"/"),e=a.target.substring(f);console.log(e),d.root.getFile(e,{create:!1},function(d){var f=c.getTargetCount(e);f>1?(c.removeTask(a.url),c.saveState(),c.trigger("removeSuccess",a),c.trigger("removeSuccessCount",b)):d.remove(function(){c.removeTask(a.url),c.saveState(),c.trigger("removeSuccess",a),c.trigger("removeSuccessCount",b)},function(d){console.error("remove err: %s",d),c.trigger("removeError",a),c.trigger("removeErrorCount",b)})},function(d){c.removeTask(a.url),c.saveState(),console.error("getFile err: %s",d),c.trigger("getError",a),c.trigger("getErrorCount",b)})},function(a){console.error(a)})},removeFileBatch:function(b){var c=this,d=b.length;a.each(b,function(a){window.cordova&&c.deleteFile(a,d)})},onRemoveSuccessCount:function(a){this.successCount=this.successCount+1,this.triggerReload(a)},onRemoveErrorCount:function(a){this.errorCount=this.errorCount+1,this.triggerReload(a)},onGetErrorCount:function(a){this.successCount=this.successCount+1,this.triggerReload(a)},triggerReload:function(a){var b=this;b.successCount+b.errorCount==a&&(b.trigger("reloadData",b.successCount),b.successCount=0,b.errorCount=0)},openFile:function(a){var b=this;window.cordova&&window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(c){if("iOS"==device.platform)var d=a.target.substring(c.root.nativeURL.length);else var e=a.target.indexOf(butterfly.config.identifier+"/"),d=a.target.substring(e);console.log(d),c.root.getFile(d,{create:!1},function(c){b.trigger("fileExist",a)},function(c){b.trigger("fileNoExist",a)})},function(a){b.trigger("openError")})}}),new c});