define(["butterfly/components/dialog/zepto_extend","butterfly/components/dialog/parseTpl","css!butterfly/components/dialog/dialog.css","css!butterfly/components/dialog/dialog.default.css"],function(){function a(a){this.tpl={close:'<a class="ui-dialog-close" title="关闭"><span class="ui-icon ui-icon-delete"></span></a>',mask:'<div class="ui-mask"></div>',title:'<div class="ui-dialog-title"><h3><%=title%></h3></div>',wrap:'<div class="ui-dialog"><div class="ui-dialog-content"></div><% if(btns){ %><div class="ui-dialog-btns"><% for(var i=0, length=btns.length; i<length; i++){var item = btns[i]; %><a class="ui-btn ui-btn-<%=item.index%>" data-key="<%=item.key%>"><%=item.text%></a><% } %></div><% } %></div> '},this.toastTpl={close:'<a class="ui-dialog-close" title="关闭"><span class="ui-icon ui-icon-delete"></span></a>',mask:"",wrap:'<div class="ui-dialog" style="background: #363636; color: #fff;margin:0 10px"><div class="ui-dialog-content" style="padding:4px 10px;font-size: 16px;border-radius: 9px;"></div></div> '},this._options={autoOpen:!0,buttons:null,closeBtn:!1,mask:!0,width:300,height:"auto",title:null,content:null,scrollMove:!0,container:null,maskClick:null,position:null},this.getWrap=function(){return this._options._wrap},this._init=function(a){a?(this.tpl=this.toastTpl,this._options.isToast=!0):this._options.isToast=!1;var b=d(".ui-dialog");if(0===b.length||"visible"!==window.getComputedStyle(b[b.length-1]).getPropertyValue("visibility")){var c,e=this,f=e._options,g=0,h=d.proxy(e._eventHandler,e),i={};d(document).ready(function(){f._container=d(f.container||document.body),(f._cIsBody=f._container.is("body"))||f._container.addClass("ui-dialog-container"),i.btns=c=[],f.buttons&&d.each(f.buttons,function(a){c.push({index:++g,text:a,key:a})}),f._mask=f.mask?d(e.tpl.mask).appendTo(f._container):null,f._wrap=d(d.parseTpl(e.tpl.wrap,i)).appendTo(f._container),f._content=d(".ui-dialog-content",f._wrap),f._title=d(e.tpl.title),f._close=f.closeBtn&&d(tpl.close).highlight("ui-dialog-close-hover"),e.$el=e.$el||f._content,e.title(f.title),e.content(f.content),c.length&&d(".ui-dialog-btns .ui-btn",f._wrap).highlight("ui-state-hover"),f._wrap.css({width:f.width,height:f.height}),d(window).on("ortchange",h),f._wrap.on("click",h),f._mask&&f._mask.on("click",h),f.autoOpen&&e.open()}),f._wrap.bind("animationend  webkitAnimationEnd  oAnimationEnd  MSAnimationEnd",function(a){"disappear"===a.animationName&&(f._wrap.css("visibility","hidden"),f.autoOpen&&e.destroy())})}},this._create=function(){var a=this._options;this._options.setup&&(a.content=a.content||this.$el.show(),a.title=a.title||this.$el.attr("title"))},this._eventHandler=function(a){var b,c,e,f=this,g=f._options;switch(a.type){case"ortchange":this.refresh();break;case"touchmove":g.scrollMove&&a.preventDefault();break;case"click":if(g._mask&&(d.contains(g._mask[0],a.target)||g._mask[0]===a.target))return;c=g._wrap.get(0),(b=d(a.target).closest(".ui-dialog-close",c))&&b.length?f.close():(b=d(a.target).closest(".ui-dialog-btns .ui-btn",c))&&b.length&&(e=g.buttons[b.attr("data-key")],e&&e.apply(f,arguments))}},this._calculate=function(){var a,b,c=this,e=c._options,f=document.body,g={},h=e._cIsBody,i=Math.round;return e.mask&&(g.mask=h?{width:"100%",height:Math.max(f.scrollHeight,f.clientHeight)-1}:{width:"100%",height:"100%"}),a=e._wrap.offset(),b=d(window),g.wrap={left:"50%",marginLeft:-i(a.width/2)+"px",top:h?i(b.height()/2)+window.pageYOffset:"50%",marginTop:-i(a.height/2)+"px"},c._options.isToast&&(g.wrap={left:"50%",marginLeft:-i(a.width/2)+"px",top:"200px",marginTop:-i(a.height/2)+"px"}),g},this.refresh=function(){var a,b,c=this,e=c._options;return e._isOpen&&(b=function(){e._wrap.css("-webkit-animation","null"),e._wrap.css("animation","null"),a=c._calculate(),a.mask&&e._mask.css(a.mask),e._wrap.css(a.wrap),e._wrap.css("-webkit-animation"," bounceOut 0.1s"),e._wrap.css("animation"," bounceOut 0.1s")},d.os.ios&&document.activeElement&&/input|textarea|select/i.test(document.activeElement.tagName)?(document.body.scrollLeft=0,setTimeout(b,200)):b()),c};var b=this;this._listenDomRemoved=function(a){var c=b;if(a.target){var e=d(a.target).find(c.$el);e&&e.length>0&&(d(document).off("touchmove",c._eventHandler),document.removeEventListener("DOMNodeRemoved",c._listenDomRemoved))}},this.open=function(a,b){var c=this._options;if(!c._isOpen&&c._wrap){c._isOpen=!0,c._wrap.css("visibility","visible"),c._mask&&c._mask.css("visibility","visible"),void 0!==a&&this.position?this.position(a,b):this.refresh();var e=this;d(document).on("touchmove",d.proxy(e._eventHandler,e)),document.addEventListener("DOMNodeRemoved",this._listenDomRemoved,!1)}},this.close=function(){var a=this._options;a._wrap&&(a._isOpen=!1,a._wrap.css("-webkit-animation"," disappear 0.2s"),a._wrap.css("animation"," disappear 0.2s"),a._mask&&a._mask.css("visibility","hidden"),d(document).off("touchmove",this._eventHandler))},this.title=function(a){var b=this._options,c=void 0!==a;return c&&(a=(b.title=a)?"<h3>"+a+"</h3>":a,b._title.html(a)[a?"prependTo":"remove"](b._wrap),b._close&&b._close.prependTo(b.title?b._title:b._wrap)),c?this:b.title},this.content=function(a){var b=this._options,c=void 0!==a;return c&&b._content.empty().append(b.content=a),c?this:b.content},this.destroy=function(){var a=this._options,b=this._eventHandler;d(window).off("ortchange",b),d(document).off("touchmove",b),a._wrap.off("click",b).remove(),a._mask&&a._mask.off("click",b).remove(),a._close&&a._close.highlight()},void 0!==a.autoOpen&&(this._options.autoOpen=a.autoOpen),a.buttons&&(this._options.buttons=a.buttons),void 0!==a.mask&&(this._options.mask=a.mask),void 0!==a.closeBtn&&(this._options.closeBtn=a.closeBtn),a.width&&(this._options.width=a.width),a.height&&(this._options.height=a.height),a.title&&(this._options.title=a.title),a.content&&(this._options.content=a.content),void 0!==a.scrollMove&&(this._options.scrollMove=a.scrollMove),a.container&&(this._options.container=a.container),a.maskClick&&(this._options.maskClick=a.maskClick),a.position&&(this._options.position=a.position)}function b(b,c){var d=new a({content:b});d._options.width="auto",d._init(!0),c=3e5,setTimeout(function(){d.close()},c)}function c(b){if(0==d(".ui-dialog-btns").length){var c=new a(b);return c._init(),c}}var d=Zepto;return{showToast:b,createDialog:c}});