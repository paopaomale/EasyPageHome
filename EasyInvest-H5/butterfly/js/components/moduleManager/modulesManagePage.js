define(["butterfly/view","iscroll","backbone","components/moduleManager/moduleManager"],function(a,b,c,d){return a.extend({events:{"click .module-list":"goDetail","click .edit":"getAll","click .goback":"goBack"},render:function(){return a.prototype.render.call(this),this},goBack:function(){window.history.back()},onShow:function(){if(!this.hasShown){var a=this;a.$el.parent().find(".content").append("<div class='chrysanthemum-shadom'><div class='chrysanthemum active'><div></div></div></div>");var b=2;a.initializeInstalledModules(function(){a.initializeNotInstallModules(function(){0==--b&&a.taskAfter()})}),a.initializeUpdateModules(function(){0==--b&&a.taskAfter()})}this.hasShown=!0},taskAfter:function(){var a=this;_.map(a.result1,function(a){a.type="install"});var c=_.object(_.map(a.result1,function(a){return a.identifier}),a.result1);_.map(a.result2,function(b,d){b.type="update",c[b.identifier]&&a.result2.splice(d,1)}),a.result3=a.result1.concat(a.result2),a.$el.parent().find(".chrysanthemum-shadom").remove(),this.myScroll=new b("#modules-wrapper"),a.listInitialize(a.result3,"category"),a.request("auto")&&this.result3.length>0&&(new d).downloadModules(this.result3),a.uiEditButton("update")},initializeInstalledModules:function(a){var b=this;(new d).getLocalModulesInfo(function(c){c.length>0&&(b.result=c),a()},function(){b.uiAjaxError()})},initializeNotInstallModules:function(a){var b=this;(new d).getLastestModulesUpdateInfo(function(c){var d=_.object(_.map(b.result,function(a){return a.identifier}),b.result);b.result1=_.reject(c,function(a){return d[a.identifier]}),a()},function(a){b.uiAjaxError()})},initializeUpdateModules:function(a){var b=this;(new d).checkModulesUpdate(function(c){if(c.length>0){b.result2=c;var d=JSON.parse(window.sessionStorage.getItem("updateCompleteModules"));if(null!=d&&""!=d){var e=_.object(_.map(d,function(a){return a.identifier}),d);b.result2=_.filter(b.result2,function(a){return a.version>e[a.identifier].version?e[a.identifier]:void 0})}}else b.result2=[];a()},function(){b.uiAjaxError()})},uiAjaxError:function(){var a=this;a.$el.parent().find(".chrysanthemum-shadom").remove();var b='<div style="height:40px;width:100%;text-align:center;vertical-align: middle;padding-top:7px;">网络请求失败，请检查网络</div>';a.$el.find("#modules-temp").empty(),a.$el.find("#modules-temp").append(b)},listInitialize:function(a,b){var c=this,d=_.uniq(_.pluck(a,b));if(_.each(d,function(a){var b;b=a===!0?"业务模块":a===!1?"功能模块":a,c.$el.find("#modules-temp").append("<div class="+a+'><div class="temp-category">'+b+"</div></div>")}),a&&a.length>0)a.forEach(function(a){var d,e=_.template(c.$el.find("#modules-template").html(),a);d="category"===b?a.category:a.hidden,c.$el.find("#modules-temp").find("."+d).append(e),c.myScroll.refresh()});else{c.$el.find("#modules-temp").empty();var e='<div style="height:40px;width:100%;text-align:center;vertical-align: middle;padding-top:7px;">无模块更新</div>';c.$el.find("#modules-temp").append(e)}},uiEditButton:function(a){"update"===a&&this.result3.length>0?(this.$el.find(".edit").show(),this.$el.find(".edit").find("span").html("安装全部")):this.$el.find(".edit").hide()},getAll:function(a){var b=$(a.currentTarget),c=$(b).find("span").text();"安装全部"===c&&(new d).downloadModules(this.result3)},goDetail:function(a){var b=this,c=$(a.currentTarget)[0],d=$(c).attr("data-identifier"),e=_.find(b.result3,function(a){return a.identifier==d});window.sessionStorage.setItem("moduleManageDetail",JSON.stringify(e)),butterfly.navigate("components/moduleManager/modulesManageDetail.html?update",{trigger:!0,effect:"slideInDown"})},request:function(a){var b,c=location.href,d=c.substring(c.indexOf("?")+1,c.length).split("&");for(i=0;i<d.length;i++){var e=d[i].split("=")[0],f=d[i].split("=")[1];e===a&&(b=f)}return"undefined"==typeof b?"":b}})});