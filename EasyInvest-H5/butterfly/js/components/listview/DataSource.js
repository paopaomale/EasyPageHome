define(["underscore","jquery","butterfly/extend"],function(a,b,c){var d=["identifier","url","requestParams","pageParam","pageSizeParam","startParam","countParam","storage"],e=function(b){var c={pageParam:"pageIndex",pageSizeParam:"pageSize",startParam:"start",countParam:"count",storage:"session"},e=a.pick(b,d);this.options=a.extend(c,e),this._initCache(),this.initialize.apply(this,arguments)};return e.extend=c,a.extend(e.prototype,{initialize:function(){},clear:function(){this.finish=!1,this.cache=[],this.persist()},get:function(a){return this.cache[a]},set:function(a,b){this.cache[a]=b},size:function(){return this.cache.length},_initCache:function(){var a;switch(this.options.storage){case"local":a=window.localStorage["datasource-"+this.options.identifier];break;case"session":a=window.sessionStorage["datasource-"+this.options.identifier];break;case"none":a=null}a?this.cache=JSON.parse(a):this.cache=[]},persist:function(){switch(console.log("数据源[%s]持久化，介质[%s]",this.options.identifier,this.options.storage),this.options.storage){case"local":window.localStorage["datasource-"+this.options.identifier]=JSON.stringify(this.cache);break;case"session":window.sessionStorage["datasource-"+this.options.identifier]=JSON.stringify(this.cache);break;case"none":}},loadDataFromCache:function(b,c){var d=this,e=a.range(b,b+c),f=a.any(e,function(a){return void 0==d.cache[a]});if(f)return console.log("datasource.cache.miss: "+b+"~"+c),null;console.log("datasource.cache.hit: "+b+"~"+c);var g=this.cache.slice(b,b+c);return g},loadData:function(b,c,d,e){var f=this,g=this.loadDataFromCache(b*c,c);if(g)d&&d(g);else{var h={};h[f.options.pageParam]=b,h[f.options.pageSizeParam]=c,f.ajaxLoadData({url:f.options.url,data:a.extend(h,f.options.requestParams),success:function(e){a.each(e,function(a,d){f.set(b*c+d,a)}),f.persist(),d&&d(e,f.finish)},fail:e})}},setRequestParams:function(a){this.options.requestParams=a},ajaxLoadData:function(a){b.ajax({url:a.url,type:"GET",dataType:"json",data:a.data,timeout:5e3,success:function(b){b instanceof Array?a.success(b):a.success(b.data)},error:function(b,c){a.fail(b,c)}})},setFinish:function(){this.finish=!0}}),e});