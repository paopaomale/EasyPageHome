define(["jquery","underscore","backbone","./ListViewTemplateItem","dialog","../shared/js/jquery.lazyload.min","iscrollprobe"],function(a,b,c,d,e){var f=["id","autoLoad","itemTemplate","itemClass","dataSource","pageSize","isPullToRefresh","isLoadSuccess"],g=c.View.extend({events:{"click .loadmore":"onLoadMore","click li":"onRowSelect"},defaults:{autoLoad:!0,editing:!1,page:0,pageSize:20,isPullToRefresh:!0,isLoadSuccess:!1},initialize:function(){var c=this;this.subviews=[],b.extend(this,this.defaults,b.pick(arguments[0],f)),this.itemTemplate&&(this.itemClass=d.extend({template:this.itemTemplate})),c.IScroll=new IScroll(this.el,{probeType:2,scrollX:!1,scrollY:!0,mouseWheel:!0,isPullToRefresh:this.isPullToRefresh}),this.el.querySelector(".pulldown")&&this.el.classList.add("withpulldown");var e=(a(c.IScroll.wrapper),this.$pullDown=this.$(".pulldown")),g=this.$pullUp=this.$("ul~.pullup");if(c.IScroll.on("scrollStart",function(){this.startY=this.y,!g.hasClass("_empty")&&c.isLoadSuccess&&g.addClass("withpullup")}),c.IScroll.on("scroll",function(){this.y>10?(e.addClass("flip").find(".label").html("释放更新"),this.minScrollY=0):this.y<10&&c.isLoadSuccess&&(e.removeClass("flip").find(".label").html("下拉刷新"),this.minScrollY=-e.outerHeight()),!g.hasClass("_empty")&&c.isLoadSuccess&&g.addClass("flip").addClass("loading").find(".label").html("加载中,请稍候...")}),c.IScroll.on("scrollEnd",function(){e.hasClass("flip")&&c.onPullDown(),this.startY-this.y>=0&&Math.abs(this.maxScrollY)-Math.abs(this.y)<60&&g.length&&!g.hasClass("_hidden")&&c.isLoadSuccess&&!c.IScroll.isLoading&&(g.addClass("withpullup"),c.onPullUp())}),this.autoLoad){var h=this.loadState();h?this.restoreData(h):this.reloadData()}},refresh:function(){var a=this;setTimeout(function(){a.IScroll.refresh()},0)},refreshByState:function(a){var b=this;setTimeout(function(){b.IScroll.refresh(),b.IScroll.scrollTo(0,a.y)},0)},onRowSelect:function(a){var c=a.currentTarget,d=this.el.querySelector("ul").children,e=b.indexOf(d,c),f=this.subviews[e];this.editing?(f.toggleSelect(),this.trigger("editItemSelect",this,f,e,a)):this.trigger("itemSelect",this,f,e,a)},onPullDown:function(){var a=this;a.reloadData()},onLoadMore:function(a){var b=this,c=a.currentTarget;c.classList.add("loading"),this.dataSource.loadData(this.page+1,this.pageSize,function(a,d){b.page++,c.classList.remove("loading"),d?(b.$(".loadmore").removeClass("visible"),b.$pullUp.addClass("_empty")):(b.$(".loadmore").addClass("visible"),b.$pullUp.removeClass("_empty").find(".label").html("上拉加载更多...")),d&&0==a.length&&b.$(".message, .message .empty").addClass("visible"),a&&a.length>0&&a.forEach(function(a){var c=new b.itemClass({data:a});c.setEditing(b.editing),b.addItem(c)}),b.refresh(),setTimeout(function(){b.trigger("load",b),b.setScrollerMinHeight()},0)},function(a){c.classList.remove("loading"),b.refresh(),b.trigger("error",b)})},onPullUp:function(){var a=this;a.$pullUp.hasClass("_empty")||a.$(".message").hasClass("visible")||(a.IScroll.isLoading=!0,this.dataSource.loadData(this.page+1,this.pageSize,function(b,c){a.page++,a.IScroll.isLoading=!1,a.$pullUp.removeClass("flip").removeClass("loading"),c?a.$pullUp.addClass("_empty").find(".label").html("暂无更多数据"):a.$pullUp.removeClass("_empty").find(".label").html("上拉加载更多..."),c&&0==b.length&&(a.$pullUp.removeClass("flip").removeClass("loading"),a.$pullUp.addClass("_empty").find(".label").html("暂无更多数据")),b&&b.length>0&&b.forEach(function(b){var c=new a.itemClass({data:b});c.setEditing(a.editing),a.addItem(c)}),a.refresh(),setTimeout(function(){a.trigger("load",a),a.setScrollerMinHeight()},0)},function(b){a.IScroll.isLoading=!1,a.$pullUp.removeClass("flip").removeClass("loading"),a.$pullUp.removeClass("withpullup"),a.$pullUp.addClass("_hidden"),a.refresh(),a.trigger("error",a)}))}},{clear:function(a){delete window.sessionStorage["ListView:"+a]}});return b.extend(g.prototype,{saveState:function(){var a={y:this.IScroll.y,page:this.page,finish:this.dataSource.finish,items:this.subviews.length};window.sessionStorage["ListView:"+this.id]=JSON.stringify(a)},loadState:function(){var a=window.sessionStorage["ListView:"+this.id];return a?JSON.parse(a):a},restoreData:function(a){console.log("ListView.restoreData");var b=this;this.page=a.page,this.finish=a.finish;var c=this.dataSource.loadDataFromCache(0,a.items);c&&c.length>0?(c.length<this[this.dataSource.options.pageSizeParam]&&(this.finish=!0),finish?(b.$(".loadmore").removeClass("visible"),b.$pullUp.addClass("_empty")):(b.$(".loadmore").addClass("visible"),b.$pullUp.removeClass("_empty").find(".label").html("上拉加载更多...")),this.finish&&0==c.length?(b.$pullUp.removeClass("flip").removeClass("loading"),b.$pullUp.addClass("_empty").find(".label").html("暂无更多数据")):(b.$pullUp.addClass("flip").addClass("loading"),b.$pullUp.removeClass("_empty").find(".label").html("加载中,请稍候..."),b.$(".message, .message .empty").removeClass("visible")),b.deleteAllItems(),c.forEach(function(a){var c=new b.itemClass({data:a});c.setEditing(b.editing),b.addItem(c)}),b.refreshByState(a),setTimeout(function(){b.trigger("load",b),b.setScrollerMinHeight()},0)):this.reloadData()}}),b.extend(g.prototype,{setEditing:function(a){this.subviews.forEach(function(b){b.setEditing(a)}),this.editing=a},reset:function(){this.page=0,this.$(".loadmore").removeClass("visible"),this.$(".message, .message > div").removeClass("visible")},reloadData:function(){console.log("ListView.reloadData");var a=this;this.reset(),this.dataSource.clear(),this.IScroll.minScrollY=0,this.IScroll.isLoading=!0,this.IScroll.scrollTo(0,0,600,""),this.$pullDown.removeClass("flip").addClass("loading").find(".label").html("加载中,请稍候..."),setTimeout(function(){a.dataSource.loadData(a.page,a.pageSize,function(b,c){(null==b||""==b)&&(b=[]),a.IScroll.isLoading=!1,a.isLoadSuccess=!0,a.$pullDown.removeClass("flip loading").find(".label").html("下拉刷新..."),c?(a.$(".loadmore").removeClass("visible"),a.$pullUp.addClass("_hidden").addClass("_empty")):(a.$(".loadmore").addClass("visible"),a.$pullUp.addClass("withpullup"),a.$pullUp.removeClass("_empty").removeClass("_hidden").find(".label").html("上拉加载更多...")),c&&0==b.length&&a.$(".message, .message .empty").addClass("visible"),a.deleteAllItems(),b.forEach(function(b){var c=new a.itemClass({data:b});c.setEditing(a.editing),a.addItem(c)}),a.refresh(),setTimeout(function(){a.trigger("load",a),a.setScrollerMinHeight()},0)},function(b,c,d){a.IScroll.isLoading=!1,1!=d&&(a.$pullUp.removeClass("withpullup"),a.$pullUp.addClass("_hidden"),a.$pullDown.removeClass("flip loading").find(".label").html("下拉刷新..."),a.isLoadSuccess?e.showToast("加载数据失败！"):a.$(".message, .message .error").addClass("visible")),a.refresh(),setTimeout(function(){a.trigger("error",a),a.setScrollerMinHeight()},0)})},this.isPullToRefresh?400:0)},addItem:function(a){var b=this;this.subviews.push(a),this.el.querySelector("ul").appendChild(a.el),b.$(".lazyload img").lazyload({event:"sporty",load:function(){b.scroller&&b.scroller.refresh()}}),this.$(".lazyload img").trigger("sporty")},deleteItems:function(a,c){this.subviews=b.filter(this.subviews,function(b,c){return a.indexOf(c)>=0&&b.remove(),a.indexOf(c)<0}),c&&this.refresh()},deleteAllItems:function(a){b.each(this.subviews,function(a){a.remove()}),this.subviews=[],a&&this.refresh()},selectedItems:function(){return b.filter(this.subviews,function(a){return a.selected})},selectedIndexes:function(){var a=this.subviews;return b.chain(a).filter(function(a){return a.selected}).map(function(b){return a.indexOf(b)}).value()},setScrollerMinHeight:function(){var b=this,c=this.IScroll.wrapperHeight,d=a(this.IScroll.scroller).find(".pulldown").outerHeight(),e=c+d+1;this.$el.find(".scroller").css("min-height",e),setTimeout(function(){b.IScroll.refresh()},400)}}),g});