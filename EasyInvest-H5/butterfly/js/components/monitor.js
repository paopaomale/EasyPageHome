define(["jquery","underscore","backbone"],function(a,b,c){var d,e,f,g,h=1,i="in_view",j="in_app",k="enter_app",l="got_event",m=new Date,n=void 0===window.localStorage.monitor_firsttime,o=c.View.prototype.delegateEvents,p=/^(\S+)\s*(.*)$/,q=[],r=function(a){if(!a)return"";var c=b.find(q,function(b){return 0===a.indexOf(b.name)});return c?c.module.identifier:a},s=function(c){if(d){var f=b.find(d.options.whitelist,function(a){return"*"==a||a==c.type});if(void 0===f)return;var g=a(c.target),h=g.attr("id")||g.prop("outerHTML");d.gather(r(e),1,l,{timestamp:new Date,path:e,target:h,type:c.type})}};window.localStorage.setItem("monitor_firsttime",!1);var t=function(c,d){if(!c.appId||!c.url)throw new Error("创建Monitor的options至少要包含appId和url");var e=this;e.events=void 0===localStorage.monitor_events?[]:JSON.parse(localStorage.monitor_events),e.options=a.extend({},c),e.options.whitelist=b.union(["click"],[]||c.whitelist),e.timer=setInterval(function(){e.submit()},d||3e4)};t.prototype.gather=function(a,b,c,d){return!c||isNaN(b)?void console.log("monitor warning: invalid params"):(this.events.push({moduleId:a,name:c,type:b,extra:d}),void window.localStorage.setItem("monitor_events",JSON.stringify(this.events)))},t.prototype.appData=function(a){return void 0===a?this.appData:void(this.appData=a)},t.prototype.submit=function(){if(this.events&&0!=this.events.length){var b=this;a.ajax({url:b.options.url,type:"POST",dataType:"json",contentType:"application/json; charset=UTF-8",data:JSON.stringify({version:h,appId:b.options.appId,events:b.events,appData:b.appData}),success:function(){console.log("monitor submit success"),b.events=[],window.localStorage.setItem("monitor_events","[]")},error:function(){console.log("monitor submit error")}})}},c.View.prototype.delegateEvents=function(a){if(o.apply(this,arguments),!a&&!(a=b.result(this,"events")))return this;for(var c in a){var d=c.match(p),e=d[1],f=d[2];e+=".delegateEvents"+this.cid,""===f?this.$el.on(e,s):this.$el.on(e,f,s)}return this},console.log("monitor delegate...");var u=function(a,b){var c,d=0,e=function(a){b&&b(a)},f=function(b){if(b.isDirectory){var f=b.name;b.getFile("package.json",{create:!1},function(b){console.log("getFile ok:%o",b),console.log("loadFile %s",b.nativeURL.replace(a,"")),require(["json!"+b.nativeURL.replace(a,"")],function(a){console.log("load moduleInfo %s: %o",f,a),q.push({name:f,module:a}),++d===c&&e()},function(a){++d===c&&e()})},function(a){++d===c&&e(),console.log("monitor getFile error: %s",a)})}else++d===c&&e()};window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL,window.device&&window.resolveLocalFileSystemURL||e(),window.resolveLocalFileSystemURL(a,function(b){console.log("monitor: %s",a),b.createReader().readEntries(function(a){c=a.length;for(var b=0,d=c;d>b;b++)f(a[b])},function(){e("readEntries error.")})},function(a){e("resolveLocalFileSystemURL error")})};c.history.on("route",function(a,b,c){var h=c[0];d&&e&&f&&(g=((new Date).getTime()-f.getTime())/1e3,d.gather(r(h),0,i,{path:h,timespan:g})),e=h,f=new Date}),document.addEventListener("resume",function(){setTimeout(function(){d&&(console.log("resume : %o",d.events),d.gather("",1,k,{timestamp:new Date,firsttime:!1})),m=new Date},0)}),document.addEventListener("pause",function(){if(d){var a=((new Date).getTime()-m.getTime())/1e3;d.gather("",0,j,{timespan:a}),d.submit()}});var v=function(a){return d||(a.rootDir&&u(a.rootDir),d=new t(a,a.interval),d.gather("",1,k,{timestamp:m,firsttime:n})),d};return{create:v}});