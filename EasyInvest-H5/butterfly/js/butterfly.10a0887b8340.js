!function(a,b){"function"==typeof define&&define.amd?define(["exports","underscore","jquery","backbone","view"],function(c,d,e,f,g){a.Butterfly=b(a,c,d,e,f,g)}):a.Butterfly=b(a,{},a._,a.jQuery||a.Zepto||a.ender||a.$,Backbone)}(this,function(a,b,c,d,e,f){e.View.use=function(a){return c.extend(this.prototype,a),this},e.View.prototype.use=function(a){return c.extend(this,a),this},b.VERSION="1.1";var g=(b.Router=e.Router.extend({routes:{"*path(?*queryString)":"any"},any:function(b,c){if(console.log("route: %s ? %s",b,c),c){c=decodeURI(c);var e=JSON.parse('{"'+c.replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}');this.routingOptions=d.extend({},e,this.routingOptions),this.routingOptions.queryString=c}a.butterfly.route(b,this.routingOptions),delete this.routingOptions}}),e.history.navigate);e.history.navigate=function(b,c){a.butterfly.navigate(b,c)},b.history=e.history;var h=window.history.go,i=window.history.back;window.history.go=function(b,c){a.butterfly.back(b,c)},window.history.back=function(b){a.butterfly.back(void 0,b)};var j=b.Application=function(a){this.el=a};c.extend(j.prototype,e.Events),c.extend(j.prototype,{navigate:function(a,b){b=b||{trigger:!0},b.trigger=void 0==b.trigger?!0:b.trigger,this.router.routingOptions=b,butterfly.rootView.stack.reverse();var d;c.find(butterfly.rootView.stack,function(b,c){return b.path.slice(1)==a?(b.options&&(b.options.isPopupView=!1),d=c,b.path.slice(1)==a):void 0}),butterfly.rootView.stack.reverse(),d?window.history.go(-d,b):g.call(e.history,a,b)},back:function(a,b){var c=this.rootView.stack[this.rootView.stack.length-1].view;c.onBacking&&location.hash===this.rootView.stack[this.rootView.stack.length-1].path?c.onBacking(function(c,e){"undefined"!=typeof e&&(b=d.extend({},e,b)),c&&this.doBack(a,b)}.bind(this)):this.doBack(a,b)},doBack:function(a,b){var c=typeof a;"string"===c?this.rootView.backTo?this.rootView.backTo(a,b):console.error("root view不支持backTo方法"):"number"===c?(this.router.routingOptions=b,h.call(window.history,a)):(this.router.routingOptions=b,i.call(window.history))},route:function(a,b){this.rootView.route?this.rootView.route(a,b):console.error("rootView不支持route方法")},fly:function(){var a=this;return this.scanRootView(function(c){a.rootView=c,a.router=new b.Router;var d=window.location.pathname,f=d.substr(0,d.lastIndexOf("/"));console.log("start history with root: [%s]",f),e.history.start({pushState:!1,root:f}),c.show()},function(a){throw console.error("fail to load root view: %s",a),a}),this},scanRootView:function(a,b){var c=this.el.querySelector("[data-view]");if(!c)throw new Error("root view not found");c.setAttribute("has-subview","true"),f.loadView(c,function(b){var c=new b;a(c)},b)}}),b.Application.extend=e.Router.extend;var k=function(b){a.butterfly=new b(document.body),a.butterfly.fly()};return d(function(){var a=d(document.body).attr("application");a?require([a],function(a){if(!c.isFunction(a)||!c.isFunction(a.prototype.fly)){var b="自定义Application必须从Butterfly.Application继承";throw new Error(b)}k(a)}):k(j)}),b});