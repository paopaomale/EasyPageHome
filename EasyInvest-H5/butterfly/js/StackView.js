define(["butterfly/view"],function(a){var b={slideInRight:{go:"slideInRight",back:"slideOutRight"},slideInUp:{go:"slideInUp",back:"slideOutDown"},slideInDown:{go:"slideInDown",back:"slideOutUp"},fadeIn:{go:"fadeIn",back:"fadeOut"},fadeInUp:{go:"fadeInUp",back:"fadeOutDown"},fadeInDown:{go:"fadeInDown",back:"fadeOutUp"},fadeInDownBig:{go:"fadeInDownBig",back:"fadeOutUpBig"},fadeInUpBig:{go:"fadeInUpBig",back:"fadeOutDownBig"},fadeInRight:{go:"fadeInRight",back:"fadeOutRight"},fadeInRightBig:{go:"fadeInRightBig",back:"fadeOutRightBig"}},c="viewchanged",d=function(a,b,d,e){a?(b.onHide(),d.onShow(e),b.remove(),b.onDestroy&&b.onDestroy()):(b.onHide(),d.onShow(e)),window.butterfly.trigger(c,{isGoBack:a,currentView:b,nextView:d,options:e})},e=function(a,c,e,f){var g=f&&f.effect;if(void 0===g&&(g="slideInRight"),null!==g&&"object"==typeof g){var h=a?g.back:g.go;"function"==typeof h?h(c,e,function(){d(a,c,e,f)}):d(a,c,e,f)}else if("string"==typeof g&&b[g]){var i=a?b[g].back:b[g].go,j=a?c:e;i?j.animate(i,function(){d(a,c,e,f)}):d(a,c,e,f)}else d(a,c,e,f)};return a.extend({initialize:function(b){a.prototype.initialize.apply(this,arguments),this.stack=[],this.baseZIndex=100,this.routedOnce=!1},render:function(){_.each(this.stack,function(a){a.view.render()})},onShow:function(a){var b=this.stack[this.stack.length-1].view;b.onShow(a)},addSubview:function(b,c){a.prototype.addSubview.apply(this,arguments),b.$el.css({position:"absolute",top:"0px",bottom:"0px",width:"100%","z-index":this.baseZIndex++}),this.stack.push({path:"",view:this.subviews[0]})},currentView:function(){return this.stack.length>1?this.stack[this.stack.length-1].view:void 0},checkBackLevel:function(a){void 0===a&&(a=window.location.hash);for(var b=0,c=this.stack.length-2;c>=0;c--)if(this.stack[c].path==a){b=this.stack.length-c-1;break}return b},backTo:function(a,b){"string"==typeof a&&"#"!=a[0]&&(a="#"+a);var c=this.checkBackLevel(a);0===c?console.log("backTo: 回退的url不正确"):window.history.go(-c,b)},route:function(a,b){var c=this;if(1==this.stack.length&&!a)return void(this.routedOnce=!0);var f=this.checkBackLevel(),g=this.stack[this.stack.length-1].view;if(f>0){for(var h=this.stack[this.stack.length-1-f],i=h.view,j=f;j>0;){var k=this.stack.pop();f>j&&(k.view.onHide(),k.view.remove()),j--,this.baseZIndex--}b=_.extend(h.options||{},b),b.isBack=!0,e(!0,g,i,b)}else require(["view!"+a],function(a){var f=new a;f.$el.css({position:"absolute",top:"0px",bottom:"0px",width:"100%","z-index":c.baseZIndex++}),setTimeout(function(){c.stack.push({path:window.location.hash,view:f,options:b})},0),f.render(b),c.el.appendChild(f.el),c.routedOnce?e(!1,g,f,b):d(!1,g,f,b),c.routedOnce=!0},function(a){alert("页面加载失败")})}})});