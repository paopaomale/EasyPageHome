define(["butterfly/view","butterfly","../mall/mall-client","listview/ListView","../shared/js/datasource","dialog","../shared/js/loading","swipe","iscrollprobe"],function(a,b,c,d,e,f,g){return a.extend({events:{"click .go-back":"goBack","click .menuLi":"goodsList","click .item":"onGoodsDetail"},menuScroll:null,goodsScroll:null,goodsType:null,render:function(){console.log("render"),this.initLoading(),this.getGoodsTypeData(),this.getGoodsList()},onShow:function(){this.initAdSwiper(),this.setMinHeight()},initLoading:function(){this.loading=new g({parentEl:this.$(".container")[0]})},onGoodsDetail:function(a){var b=$(a.currentTarget).attr("goods-id");console.log("onGoodsDetail"),butterfly.navigate("mall/goods-detail.html",{goodId:b})},goodsList:function(a){var b=this,c=$(a.currentTarget).attr("id");b.$(".menuLi").removeClass("menu-action"),$(a.currentTarget).addClass("menu-action");var d=b.computeScrollHeight(c);b.goodsScroll.scrollTo(0,-d)},computeScrollHeight:function(a){for(var b=this,c=b.$(".menuLi"),d=0,e=0,f=c.length;f>e&&$(c[e]).attr("id")!=a;e++)d+=$(".goods-list #"+$(c[e]).attr("id")).height();return d},initListView:function(){var a=this;a.datasource=new e({url:c.GET_SELLING_GOODS_LIST_URL,pageParam:"pageIndex"});var b=this.el.querySelector("#integral-list"),f=_.template(this.$("#selling-goods-list-template").html());a.listview=new d({id:"selling-goods-list",el:b,autoLoad:"true",itemTemplate:f,dataSource:this.datasource}),a.listenTo(this.listview,"itemSelect",this.onItemSelect)},initMenu:function(a){var b=this,c=_.template(b.$("#mall-menu-template").html(),a);b.$(".menuUl").html(""),b.$(".menuUl").append(c)},initGoodsList:function(a){var b=this;a.data=_.groupBy(a.data,"tid");var c=_.template(b.$("#selling-goods-list-template").html(),a);b.$(".goods-list").html(""),b.$(".goods-list").append(c),b.initGoodsIscroll()},getGoodsList:function(){var a=this,b={};c.getGoodsList({data:b,beforeSend:function(){a.loading&&a.loading.show()},success:function(b){0==b.result?a.initGoodsList(b):console.log("请求获取热卖商品数据失败")},error:function(a){f.showToast("获取热卖商品数据取失败,请检查网络")},complete:function(){a.loading&&a.loading.hide()}})},getGoodsTypeData:function(){var a=this,b={};c.getGoodsType({data:b,beforeSend:function(){a.loading&&a.loading.show()},success:function(b){0==b.result?a.initMenu(b):console.log("请求商品类型数据失败")},error:function(a){f.showToast("商品类型数据取失败,请检查网络")},complete:function(){a.loading&&a.loading.hide()}})},initAdSwiper:function(){var a=this;this.$el.find("#adSwipe .swiper-container");console.log(a.$("#adSwipe .swiper-container")[0]),a.swipe1=new Swipe(a.$("#adSwipe .swiper-container")[0],{continuous:!0,auto:500,callback:function(b){a.adCount<=b&&(b-=a.adCount),a.$(".addImg-pagination > span.active").removeClass("active"),$(a.$(".addImg-pagination > span")[b]).addClass("active")}})},initMenuIscroll:function(){var a=this;a.menuScroll?a.menuScroll.refresh():(a.menuScroll=new IScroll(a.$(".leftMenu-box")[0],{mouseWheel:!0,probeType:3}),a.menuScroll.on("scroll",function(){})),a.menuScroll.refresh()},getBoodsTypeWidth:function(){},initGoodsIscroll:function(){var a=this;if(a.goodsScroll)a.goodsScroll.refresh();else{a.goodsScroll=new IScroll(a.$(".goods-list-box")[0],{probeType:2});var b=function(){a.setAction(this)};a.goodsScroll.on("scroll",b)}a.goodsScroll.refresh()},setAction:function(a){for(var b=this,c=$(a.wrapper).find(".goods-list-group"),d=[],e=0,f=0,g=c.length;g>f;f++){var h=$(c[f]).height();e+=h,d.push(e)}for(var i=0,j=d.length;j>i;i++)if(Math.abs(a.y)<d[i]){a.typeId=$(c[i]).attr("goods-type");break}b.$(".menuLi").removeClass("menu-action"),b.$("#"+a.typeId).addClass("menu-action")},setMinHeight:function(){var a=window.screen.height-160;$("#scroller").css("min-height",a),$(".scroller").css("min-height",a)},setScrollerMinHeight:function(){var a=this,b=this.menuScroll.wrapperHeight,c=a.$("#adSwipe").height(),d=b+c+1;this.$el.find("#scroller").css("min-height",d),setTimeout(function(){a.menuScroll.refresh()},400)}})});