define(["butterfly/view","butterfly","shared/js/datasource","listview/ListView","swipe","live/live-client","live/socket-client","iscrollprobe","moment"],function(a,b,c,d,e,f,g){return a.extend({events:{"click .go-back":"goBack","click .item-common-content":"selectVideo","click .navButton":"onNavButtonClick","click .inputButton":"submitMessage","touchstart .scroller":"onTouchStart","touchend .scroller":"onTouchEnd","touchmove .scroller":"onTouchMove"},render:function(a){this.$("[contenteditable]").addClass("needsclick"),this.$chatScroll=this.$("#one-listview .scroller"),this.initSocketClient(a),this.$("video").attr("src",a.url)},onShow:function(){this.initListviewSwipe(),this.initListview(0)},remove:function(){g.off(),g.close(),Backbone.View.prototype.remove.call(this),this.superview=null,_.each(this.subviews,function(a){a.remove()})},initSocketData:function(a){var b=Math.floor(899*Math.random()+100);if(f.haveToken()){this.userId=moment().format("x")+b;var c="跑跑"+b}else{this.userId=moment().format("x")+b;var c="跑跑"+b}this.roomId=a.roomId,this.userName=c},initSocketClient:function(a){var b=this;this.initSocketData(a),g.init(this.roomId,this.userId,this.userName),g.off(),g.on("login",function(a){b.SocketClientLogin(a)}),g.on("logout",function(a){b.SocketClientLogout(a)}),g.on("message",function(a){b.SocketClientMessage(a)})},submitMessage:function(){var a=this.$(".textarea").html();if(a){var b={roomId:this.roomId,userId:this.userId,userName:this.userName,content:a};this.chatTemp||(this.chatTemp=this.$("#chat-listview-template").html());var c=_.template(this.chatTemp,_.extend(b,{type:"myself"}));this.$chatScroll.append(c),this.initChatScroll(),this.chatScrollToEl(this.$(".item-chat-content").last()[0]),g.submit(a)}},SocketClientLogin:function(a){var b="加入了直播间";this.appendChatInfo(a,b),this.updataOnlineCount(a.onlineCount)},SocketClientLogout:function(a){var b="退出了直播间";this.appendChatInfo(a,b),this.updataOnlineCount(a.onlineCount)},updataOnlineCount:function(a){this.$("#onlineCount").html(a)},appendChatInfo:function(a,b){this.chatInfoTemp||(this.chatInfoTemp=this.$("#chat-info-template").html());var c=_.template(this.chatInfoTemp,{userName:a.user&&a.user.userName||"",info:b});this.$chatScroll.append(c),this.initChatScroll(),this.chatScrollToEl(this.$(".chat-info").last()[0])},SocketClientMessage:function(a,b){if(this.userId!==a.userId){this.chatTemp||(this.chatTemp=this.$("#chat-listview-template").html());var c=_.template(this.chatTemp,_.extend(a,{type:"other"}));this.$chatScroll.append(c),this.initChatScroll(),this.chatScrollToEl(this.$(".item-chat-content").last()[0])}},onNavButtonClick:function(a){var b=$(a.currentTarget),c=b.attr("data-value"),d=parseInt(c);this.listviewSwipe.slide(d,300)},selectVideo:function(a){var b=$(a.currentTarget).attr("data-url");this.$("video").attr("src",b)},initListview:function(a){0===a?this.initChartListview():this.initVideoListView()},initChartListview:function(){this.initChatScroll()},chatScrollToEl:function(a){this.listview0&&this.listview0.IScroll&&this.listview0.IScroll.scrollToElement(a)},initChatScroll:function(){var a=this;a.listview0?a.listview0.IScroll&&a.listview0.IScroll.refresh():(a.listview0={},a.listview0.IScroll=new IScroll(this.$("#one-listview")[0],{probeType:2,scrollX:!1,scrollY:!0,mouseWheel:!0,bounceTime:2}))},initVideoListView:function(){var a=this;if(!this.listview1){var b=new c({storage:"none",identifier:"videoDatasource",url:f.BROADCAST_VIDEO_URL,requestParams:{roomId:a.roomId}}),e=this.$("#two-listview"),g=_.template(a.$("#video-listview-template").html());this.listview1=new d({id:"videoListview",el:e,autoLoad:!0,itemTemplate:g,dataSource:b})}},initListviewSwipe:function(){var a=this;this.listviewSwipe||(this.listviewSwipe=new Swipe(a.$(".listviewSwipe")[0],{startSlide:0,continuous:!1,closeEndMotion:!0,callback:function(b,c){a.navSlide(b),a.initListview(b)},transitionEnd:function(a,b){}}))},navSlide:function(a){this.$(".navButton").removeClass("active").eq(a).addClass("active"),this.$(".scroll-lite").css("left",100*a+"%")},onTouchStart:function(a){this.touchFirst=!0,this.listviewSwipe&&this.listviewSwipe.pause(),this.swipeIndex=this.listviewSwipe.getPos(),this["listview"+this.swipeIndex]&&this["listview"+this.swipeIndex].IScroll&&(this["listview"+this.swipeIndex].IScroll.enabled=!1),this.lastX=a.originalEvent.touches[0].clientX,this.lastY=a.originalEvent.touches[0].clientY},onTouchMove:function(a){if(this.touchFirst===!0){this.clientX=a.originalEvent.touches[0].clientX,this.clientY=a.originalEvent.touches[0].clientY;var b=(Math.abs(this.clientX-this.lastX),Math.abs(this.clientY-this.lastY),Math.abs(this.clientX-this.lastX)/Math.abs(this.clientY-this.lastY));1>b||1===b?this["listview"+this.swipeIndex]&&this["listview"+this.swipeIndex].IScroll&&(this["listview"+this.swipeIndex].IScroll.enabled=!0,this.touchFirst=!1):b>1&&(this.listviewSwipe.resume(),this.touchFirst=!1)}},onTouchEnd:function(){delete this.touchFirst,this["listview"+this.swipeIndex]&&this["listview"+this.swipeIndex].IScroll&&(this["listview"+this.swipeIndex].IScroll.enabled=!0)}})});